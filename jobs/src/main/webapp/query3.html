<!DOCTYPE html>
<html>
<head>
	<meta charset="US-ASCII">
	<title>CS572 Visualization - Query 3</title>
	<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="css/jquery-ui-1.10.4.custom.min.css">
	<link rel="stylesheet" type="text/css" href="css/nv.d3.min.css">
	
	<script type="text/javascript" src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
	<script type="text/javascript"  src="js/jquery-ui-1.10.4.custom.min.js"></script>
	<script type="text/javascript" src="js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/d3.min.js"></script>
	<script type="text/javascript" src="js/nv.d3.min.js"></script>
	<script type="text/javascript"  src="http://d3js.org/topojson.v1.min.js"></script>
	<script type="text/javascript"  src="js/datamaps.world.min.js"></script>	
	<script type="text/javascript"  src="js/countryNames.js"></script>	
	<script type="text/javascript">
	
	window.apiPath = window.location.protocol + "//" + window.location.host + "/jobs/api/controller/";
	
	$(document).ready(function(){
		
		$("#serachCompany").autocomplete({
	      source: window.apiPath + 'serachCompany',
	      minLength: 3,
	      select: function( event, ui ) {
	    	  console.log(ui.item);
	    	  $( "#serachCompany").val(ui.item);    
	      }
	    });
		
		$('#btnSearchCompanyPresenceCountry').bind('click', function(event){
			$.ajax({
				url : window.apiPath + 'getCompaniesForCountry',
				type : 'POST',
				datatype : 'json',
				data : {'term' : $( "#serachCompany").val() },
				success : function(data) {
					
					var newDataArr = [];
					var fillArr = {'defaultFill': '#FDF9F4'};		
					var dataArr = {};
					for (var i in countryName) {
						dataArr[countryName[i]] = { 'jobs' : 0, 'fillKey' : 'defaultFill' };
					}
					for(var i in data) {
						var obj = data[i];
						var k = countryName[obj['name']];
						fillArr[k] = getRandomColor();
						dataArr[k] = { 'fillKey' : k, 'jobs' : obj['value'] };
						newDataArr.push(obj);
					}		
					
					renderResultsForCompany(fillArr, dataArr); 
					renderChart1(newDataArr);
					
					
				}
			});
		});
		
		$('#btnSearchCompanyPresencePoints').bind('click',  function(event){
			$.ajax({
				url : window.apiPath + 'getJobPointsForCountry',
				type : 'POST',
				datatype : 'json',
				data : {'term' : $( "#serachCompany").val() },
				success : function(data) {
					var newArr = [];
					var fillArr = {'defaultFill': '#EDDC4E', 'point' : '#E80C7A'};
					
					for(var i in data) {
						var obj = data[i];
						 if (fillArr[obj['country']] == undefined) {
							fillArr[obj['country']] = getRandomColor();
						}
						
						 /*newArr.push({
					        'radius': 3,					        
					        'fillKey': obj['country'],
					        'latitude': obj['latitude'],
					        'longitude': obj['longitude']
					      }); */ 
						newArr.push({ 'location' : data[i]});
					}
					console.log(newArr);
					renderJobPoints(newArr, fillArr);
				}
			});
			
		});
	    
		
	});
	
	function renderResultsForCompany(fillArr, dataArr) 
	{
		$('#graph').html('<div id="container" style="position: relative; width: 1200px; height: 500px;"></div>');
		var map = new Datamap(
		{
			element : document.getElementById('container'),
			geographyConfig : {
				// popupOnHover: false,
				highlightOnHover : false,
				popupTemplate : function(geo, data) {
					return [
					        '<div class="hoverinfo"><strong>',
					        'Jobs in ' + geo.properties.name,
					        ': ' + data.jobs, '</strong></div>' ]
					.join('');
				}
			},
			fills : fillArr,
			data : dataArr
		});
	}
	function renderChart1(res) 
	{
		var results = function(){ 
			return [   {
	      			      key: "Cumulative Return",
	      			      values: res
						}
					];
		};
		console.log(results());
		
		nv.addGraph(function() {
		  var chart = nv.models.discreteBarChart()
		      .x(function(d) { return d.name })    //Specify the data accessors.
		      .y(function(d) { return d.value })
		      .staggerLabels(true)    //Too many bars and not enough room? Try staggering labels.
		      .tooltips(false)        //Don't show tooltips
		      .showValues(true)       //...instead, show the bar value right on top of each bar.
		      .transitionDuration(350)
		      ;

		  d3.select('#chart svg')
		      .datum(results())
		      .call(chart);

		  nv.utils.windowResize(chart.update);

		  return chart;
		});

	}
	
	function renderJobPoints(places, fillArr) {
		
		$('#graph').html('<div id="container" style="position: relative; width: 1200px; height: 500px;"></div>');
	
		var width = 1200;
		  var height = 500;
			 
			 var projection = d3.geo.equirectangular()
		      .scale(153)
		      .translate([width / 2, height / 2])
		      .precision(.1);
			 
		 var map = new Datamap(
		{
			element : document.getElementById('container'),
			geographyConfig : {
				popupOnHover: false,
				highlightOnHover : true,
				projection: ''
			},
			setProjection: function(element) {
	          var projection = d3.geo.equirectangular()
			      .scale(153)
			      .translate([width / 2, height / 2])
			      .precision(.1);
	          var path = d3.geo.path()
	            .projection(projection);
	          
	          return {path: path, projection: projection};
	        },
			fills : fillArr,
			data : {}
		}); 
		 
		 
		/* map.bubbles(places,{
	        popupOnHover: false,
	        highlightOnHover: false
	      });  */
		

	  /* var path = d3.geo.path()
	      .projection(projection);

	  var graticule = d3.geo.graticule(); 

	   var svg = d3.select("#container").append("svg")
	      .attr("width", width)
	      .attr("height", height);

	  svg.append("path")
	      .datum(graticule)
	      .attr("class", "graticule")
	      .attr("d", path);

	  d3.json("http://bl.ocks.org//mbostock/raw/4090846/world-50m.json", function(error, world) {
	    svg.insert("path", ".graticule")
	        .datum(topojson.feature(world, world.objects.land))
	        .attr("class", "land")
	        .attr("d", path);

	    svg.insert("path", ".graticule")
	        .datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; }))
	        .attr("class", "boundary")
	        .attr("d", path);
	  });

	  d3.select(self.frameElement).style("height", height + "px");   */
	  
	   var svg = d3.select("#container svg")
	   
	/* 	svg.selectAll(".pin")
		  .data(places)
		  .enter().append("circle", ".pin")
		  .attr("r", 5)
		  .attr("transform", function(d) {
		    return "translate(" + projection([
		      d.location.longitude,
		      d.location.latitude
		    ]) + ")"
		  }); */ 
	  
	   svg.selectAll("circle")
		  .data(places)
		  .enter().append("circle")
		  .attr("r", 2)
		  .style("fill", "red")
		  .attr("transform", function(d) {
		    return "translate(" + projection([
		      d.location.longitude,
		      d.location.latitude
		    ]) + ")"
		  }); 
	}
	
	function getRandomColor() {
		var letters = '0123456789ABCDEF'.split('');
		var color = '#';
		for (var i = 0; i < 6; i++ ) {
			color += letters[Math.floor(Math.random() * 16)];
		}
		return color;
	}
	</script>
</head>
<body>
	<div class="container-fluid">
	<div class="row-fluid">
		<h3>Query 3 : Provide a map of corporate presence across South America.</h3>
	</div>
		<div class="row-fluid">
			<div class="span1">&nbsp;</div>
			<div class="span10">
				<div class="row-fluid">
				

				
					<div class="col-sm-6"> 
						<form class="form-inline">
							<input class="input" type="text" id="serachCompany" placeholder="Enter Company Name" />
							<input type="button" class="btn btn-info btn-small" value="Show Countries" id="btnSearchCompanyPresenceCountry" />
							<input type="button" class="btn btn-info btn-small" value="Show Jobs" id="btnSearchCompanyPresencePoints" />
						</form>						    
						    
					 </div>
					 
					 <div class="span6"> 
						<form class="form-inline">
						  <div class="form-group">
						    <input class="input span3" type="text" id="searchCountry" placeholder="Search Country" />
						  </div>
						    <input type="button" class="btn btn-info btn-small" value="Search" id="btnSearchCountryPresence" />
						</form>
					 </div>
				</div>	
			</div>
			<div class="span1">&nbsp;</div>
		</div>
		
		<div id="graph">
		<div id="container" style="position: relative; width: 1200px; height: 500px;"></div>
		</div>
		<div id="chart">
			<svg style="height:500px"></svg>
		</div>
	
	</div>
</body>
</html>